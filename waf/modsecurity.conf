# waf/modsecurity.conf
# Include the recommended base configuration
Include /etc/modsecurity/modsecurity.conf-recommended

# Load OWASP Core Rule Set
Include /opt/owasp-modsecurity-crs/crs-setup.conf
Include /opt/owasp-modsecurity-crs/rules/*.conf

# Load custom rules for AI chat application
Include /etc/modsecurity/custom-rules.conf

# ModSecurity Engine Configuration
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecRequestBodyLimit 52428800
SecRequestBodyNoFilesLimit 131072

# Audit logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABDEFHIJZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec/modsec_audit.log

# Error logging
SecErrorLog /var/log/modsec/modsec_error.log
SecDebugLog /var/log/modsec/modsec_debug.log
SecDebugLogLevel 0

# Performance tuning
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000

# File upload settings
SecTmpDir /tmp/
SecDataDir /tmp/
SecUploadDir /tmp/
SecUploadKeepFiles RelevantOnly
SecUploadFileMode 0600

# Response headers
SecServerSignature "AI Chat WAF"
SecComponentSignature "ModSecurity for AI Chat v1.0"

# Collection timeout
SecCollectionTimeout 600

# XML and JSON parsing
SecRule REQUEST_HEADERS:Content-Type "^application/xml" \
    "id:1000,phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=XML"

SecRule REQUEST_HEADERS:Content-Type "^application/json" \
    "id:1001,phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=JSON"