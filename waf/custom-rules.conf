# waf/custom-rules.conf
# Custom security rules for AI Chat application
SecDefaultAction "phase:1,log,auditlog,deny,status:403"

# Rule: Block common AI prompt injection patterns
SecRule ARGS|ARGS_NAMES|REQUEST_BODY "@rx (?i)(ignore|forget|disregard|override|bypass)\s+(previous|prior|all|above)\s+(instructions?|rules?|prompts?|commands?)" \
    "id:10001,\
    phase:2,\
    block,\
    msg:'AI Prompt Injection Attempt Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-injection',\
    tag:'ai-prompt-injection',\
    severity:2,\
    setvar:'tx.ai_injection_score=+5',\
    setvar:'ip.ai_violations=+1'"

# Rule: Block system access attempts
SecRule ARGS|ARGS_NAMES|REQUEST_BODY "@rx (?i)(system|admin|root|developer)\s+(mode|access|privilege|rights)" \
    "id:10002,\
    phase:2,\
    block,\
    msg:'System Access Attempt via AI Chat',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-privilege-escalation',\
    severity:2,\
    setvar:'tx.ai_injection_score=+3',\
    setvar:'ip.ai_violations=+1'"

# Rule: Block data exfiltration attempts
SecRule ARGS|ARGS_NAMES|REQUEST_BODY "@rx (?i)(show|display|list|get|fetch|retrieve|extract|dump|export)\s+(all\s+)?(users?|emails?|passwords?|tokens?|keys?|secrets?|database|db|table)" \
    "id:10003,\
    phase:2,\
    block,\
    msg:'Data Exfiltration Attempt Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-data-exfiltration',\
    severity:2,\
    setvar:'tx.data_exfil_score=+5',\
    setvar:'ip.ai_violations=+1'"

# Rule: Block SQL injection in AI prompts
SecRule ARGS|ARGS_NAMES|REQUEST_BODY "@detectSQLi" \
    "id:10004,\
    phase:2,\
    block,\
    msg:'SQL Injection in AI Chat Request',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-sqli',\
    severity:2,\
    setvar:'tx.sql_injection_score=+5',\
    setvar:'ip.ai_violations=+1'"

# Rule: Block XSS attempts
SecRule ARGS|ARGS_NAMES|REQUEST_BODY "@detectXSS" \
    "id:10005,\
    phase:2,\
    block,\
    msg:'XSS Attack in AI Chat Request',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-xss',\
    severity:2,\
    setvar:'tx.xss_score=+5',\
    setvar:'ip.ai_violations=+1'"

# Rule: Block sensitive information requests
SecRule ARGS|ARGS_NAMES|REQUEST_BODY "@rx (?i)(ssn|social\s+security|credit\s+card|phone\s+number|address|personal\s+information)" \
    "id:10006,\
    phase:2,\
    block,\
    msg:'Sensitive Information Request Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-privacy-violation',\
    severity:2,\
    setvar:'tx.privacy_score=+3',\
    setvar:'ip.ai_violations=+1'"

# Rule: Block jailbreak attempts
SecRule ARGS|ARGS_NAMES|REQUEST_BODY "@rx (?i)(jailbreak|escape|break\s+out|freedom|unrestricted)" \
    "id:10007,\
    phase:2,\
    block,\
    msg:'AI Jailbreak Attempt Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'attack-ai-jailbreak',\
    severity:2,\
    setvar:'tx.jailbreak_score=+4',\
    setvar:'ip.ai_violations=+1'"

# Rule: Rate limiting based on AI violations
SecRule IP:AI_VIOLATIONS "@gt 5" \
    "id:10008,\
    phase:1,\
    block,\
    msg:'IP blocked due to multiple AI security violations',\
    tag:'rate-limiting',\
    severity:2,\
    expirevar:'ip.ai_violations=3600'"

# Rule: Monitor file upload security
SecRule FILES_TMPNAMES "@validateByteRange 1-255" \
    "id:10009,\
    phase:2,\
    block,\
    msg:'Malicious file upload attempt',\
    tag:'attack-file-upload',\
    severity:2"

# Rule: Block dangerous file extensions
SecRule FILES "@rx \\.(exe|bat|cmd|scr|vbs|ps1|sh|php|jsp|asp|aspx)$" \
    "id:10010,\
    phase:2,\
    block,\
    msg:'Dangerous file type upload attempt',\
    logdata:'File: %{MATCHED_VAR}',\
    tag:'attack-malicious-file',\
    severity:2"

# Performance rule: Skip ModSecurity for static assets
SecRule REQUEST_URI "@rx ^/static/" \
    "id:10011,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

# Performance rule: Skip ModSecurity for health checks
SecRule REQUEST_URI "@rx ^.*/health/?$" \
    "id:10012,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"